<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Mobile App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#6366f1">
    
    <title>StudentStay v4.5 - Manager</title>
    <style>
        :root {
            /* Light Theme (Default) */
            --primary: #6366f1; /* Indigo */
            --primary-light: #e0e7ff;
            --primary-dark: #4338ca;
            --secondary: #ec4899; /* Pink/Rose for accents */
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            
            /* Status Colors */
            --success: #10b981; --success-light: #d1fae5;
            --danger: #ef4444; --danger-light: #fee2e2;
            --warning: #f59e0b; --warning-light: #fef3c7;
            --info: #0ea5e9; --info-light: #e0f2fe;

            --radius: 18px;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* Dark Theme Variables */
        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #f9fafb;
            --text-light: #9ca3af;
            --border: #374151;
            --primary-light: #312e81;
            --success-light: #064e3b;
            --danger-light: #7f1d1d;
            --warning-light: #78350f;
            --info-light: #0c4a6e;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        /* --- HEADER --- */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 20px;
            padding-top: calc(15px + var(--safe-top));
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            z-index: 10;
            color: white;
        }

        .header-content h1 { margin: 0; font-size: 1.3rem; font-weight: 800; letter-spacing: -0.5px; }
        .header-sub { font-size: 0.8rem; opacity: 0.9; font-weight: 500; }
        
        .header-btn { background: rgba(255,255,255,0.2); border: none; font-size: 1.2rem; cursor: pointer; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s; backdrop-filter: blur(5px); }
        .header-btn:active { background: rgba(255,255,255,0.4); }

        /* --- DASHBOARD --- */
        #view-dashboard {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(90px + var(--safe-bottom));
            -webkit-overflow-scrolling: touch;
        }

        /* Search Bar */
        .search-container { margin-bottom: 20px; position: sticky; top: 0; z-index: 5; }
        .search-input {
            width: 100%; padding: 14px 20px; border: 1px solid transparent; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-size: 16px; outline: none;
            background: var(--surface); color: var(--text); transition: all 0.2s;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 4px 20px rgba(99, 102, 241, 0.15); }

        /* Month Picker */
        .month-picker-container {
            background: var(--surface); padding: 12px 15px; border-radius: 12px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px; box-shadow: var(--shadow);
        }
        .month-picker-input { border: none; font-family: inherit; font-size: 16px; font-weight: 600; color: var(--text); background: transparent; outline: none; text-align: right; }

        /* Alerts */
        #dashboardAlerts { margin-bottom: 15px; }
        .alert-box {
            background: var(--danger-light); border: 1px solid var(--danger); color: var(--danger);
            padding: 12px 15px; border-radius: 12px; font-size: 0.95rem; font-weight: 600;
            display: flex; align-items: center; gap: 10px; margin-bottom: 8px; box-shadow: var(--shadow); cursor: pointer;
        }
        .alert-box.warning { background: var(--warning-light); border-color: var(--warning); color: #92400e; }

        /* Summary Cards */
        .summary-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .summary-card {
            background: var(--surface); padding: 16px; border-radius: var(--radius);
            box-shadow: var(--shadow); display: flex; flex-direction: column;
            position: relative; overflow: hidden; border-left: 5px solid transparent;
        }
        .summary-card:active { transform: scale(0.98); background: var(--bg); }
        .summary-card.income { border-left-color: var(--success); }
        .summary-card.pending { border-left-color: var(--danger); }
        .summary-card.profit { border-left-color: var(--primary); }
        .summary-card.occupancy { border-left-color: var(--warning); }

        .sum-label { font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        .sum-val { font-size: 1.4rem; font-weight: 800; color: var(--text); margin-top: 4px; }
        .sum-sub { font-size: 0.75rem; color: var(--text-light); margin-top: 2px; }

        /* Chart */
        .chart-container {
            background: var(--surface); padding: 15px; border-radius: var(--radius); margin-bottom: 20px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }
        .chart-title { font-size: 0.85rem; font-weight: 700; color: var(--text-light); margin-bottom: 15px; text-transform: uppercase; }
        .chart-bars { display: flex; align-items: flex-end; justify-content: space-between; height: 100px; padding-bottom: 5px; }
        .chart-bar-col { display: flex; flex-direction: column; align-items: center; gap: 5px; flex: 1; }
        .chart-bar { width: 12px; background: var(--primary-light); border-radius: 6px; transition: height 0.5s; position: relative; }
        .chart-bar.active { background: var(--primary); }
        .chart-label { font-size: 0.7rem; color: var(--text-light); }

        /* Tools Grid */
        .tools-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr);
            gap: 10px; 
            margin-bottom: 25px; 
        }
        .tool-card {
            background: var(--surface); padding: 12px 5px; border-radius: 16px;
            text-align: center; font-weight: 600; font-size: 0.75rem; color: var(--text);
            box-shadow: var(--shadow); display: flex; flex-direction: column; align-items: center; gap: 6px;
            transition: transform 0.1s;
        }
        .tool-card:active { transform: scale(0.95); background: var(--bg); }
        .tool-icon { font-size: 1.6rem; margin-bottom: 2px; }

        /* Filter Chips */
        .filter-bar { 
            display: flex; gap: 10px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 5px; 
            scrollbar-width: none; -ms-overflow-style: none; 
        }
        .filter-bar::-webkit-scrollbar { display: none; }
        .filter-chip {
            background: var(--surface); border: 1px solid var(--border); padding: 8px 18px; border-radius: 20px;
            font-size: 0.9rem; color: var(--text-light); white-space: nowrap; font-weight: 500;
            transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .filter-chip.active { background: var(--text); color: var(--bg); border-color: var(--text); transform: scale(1.05); }

        /* Room Card */
        .room-card {
            background: var(--surface); border-radius: var(--radius); margin-bottom: 16px;
            box-shadow: var(--shadow); overflow: hidden; position: relative;
            transition: transform 0.1s;
        }
        .room-card:active { transform: scale(0.98); }
        .room-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--bg); }
        .room-title { font-size: 1.1rem; font-weight: 700; color: var(--text); }
        .room-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 12px; font-weight: 700; text-transform: uppercase; }
        
        .bg-green { background: var(--success-light); color: var(--success); }
        .bg-red { background: var(--danger-light); color: var(--danger); }
        .bg-blue { background: var(--info-light); color: var(--info); }

        .room-body { padding: 16px; }
        .bed-visuals { display: flex; gap: 8px; margin-bottom: 12px; font-size: 1.2rem; }
        .bed-filled { opacity: 1; filter: grayscale(0); }
        .bed-empty { opacity: 0.3; filter: grayscale(1); }
        .room-stats { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-light); }
        
        .expiry-icon { position: absolute; top: 12px; right: 12px; font-size: 1.2rem; background: var(--warning-light); width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* FAB */
        .fab {
            position: absolute; bottom: calc(25px + var(--safe-bottom)); right: 25px;
            width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 2rem; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); border: none; z-index: 20;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        /* --- SLIDE OVER VIEWS --- */
        .slide-view {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg); z-index: 50; display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .slide-view.active { transform: translateX(0); }

        .view-header {
            background: var(--surface); padding: 15px 20px; padding-top: calc(15px + var(--safe-top));
            display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border);
        }
        .view-content { 
            flex: 1; overflow-y: auto; padding: 20px; 
            padding-bottom: calc(40px + var(--safe-bottom)); 
        }
        .btn-back { background: none; border: none; font-size: 1.5rem; color: var(--text); padding: 5px; }

        /* Forms & Inputs */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-light); margin-bottom: 8px; }
        .form-input {
            width: 100%; padding: 16px; border: 1px solid var(--border); border-radius: 12px;
            font-size: 16px; background: var(--surface); color: var(--text); outline: none;
            -webkit-appearance: none;
        }
        .form-input:focus { border-color: var(--primary); }

        /* Buttons */
        .btn-primary {
            background: var(--text); color: var(--bg); border: none; padding: 18px; width: 100%;
            border-radius: 14px; font-weight: 700; font-size: 1rem; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 10px;
        }
        .btn-primary:active { transform: scale(0.98); }

        /* Student List Item */
        .student-item {
            background: var(--surface); border-radius: 16px; padding: 15px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow);
        }
        .avatar {
            width: 48px; height: 48px; border-radius: 50%; background: var(--primary-light); color: var(--primary);
            display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; flex-shrink: 0;
        }
        .student-info { flex: 1; min-width: 0; }
        .st-name { font-weight: 700; font-size: 1rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .st-sub { font-size: 0.85rem; color: var(--text-light); }
        
        .action-icon {
            width: 40px; height: 40px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; flex-shrink: 0; margin-left: 5px;
        }
        .btn-wa { background: #dcfce7; color: #16a34a; }
        .btn-pay { background: var(--bg); color: var(--text-light); font-size: 0.85rem; font-weight: bold; width: auto; padding: 0 15px; border-radius: 20px; }
        .btn-pay.paid { background: var(--success); color: white; }
        .btn-doc { background: #e0f2fe; color: #0284c7; }

        /* Misc */
        .activity-feed { background: var(--surface); padding: 15px; border-radius: 16px; margin-bottom: 20px; }
        .feed-title { font-size: 0.85rem; font-weight: 700; color: var(--text-light); margin-bottom: 10px; text-transform: uppercase; }
        .feed-item { padding: 10px 0; border-bottom: 1px solid var(--border); display: flex; gap: 10px; font-size: 0.85rem; color: var(--text); }
        .feed-item:last-child { border-bottom: none; }
        .feed-time { color: var(--text-light); font-size: 0.75rem; min-width: 50px; }

        .report-box { background: var(--surface); border: 1px solid var(--border); padding: 15px; border-radius: 12px; margin-bottom: 20px; font-size: 0.9rem; }
        .report-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed var(--border); padding-bottom: 5px; }

        /* Toggle Switch */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .toggle-switch {
            position: relative; width: 50px; height: 28px; background: var(--border); border-radius: 20px; cursor: pointer; transition: 0.3s;
        }
        .toggle-switch.on { background: var(--primary); }
        .toggle-knob {
            position: absolute; top: 2px; left: 2px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: 0.3s;
        }
        .toggle-switch.on .toggle-knob { left: 24px; }

        .notes-area {
            width: 100%; background: #fefce8; border: 1px dashed #fcd34d; padding: 15px;
            border-radius: 12px; font-family: inherit; font-size: 1rem; color: #78350f; resize: none;
        }
        
        /* Lists */
        .list-item-block, .archive-item, .maint-item, .inv-item, .history-item, .todo-item {
             background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .todo-check {
            width: 24px; height: 24px; border: 2px solid var(--text-light); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 10px;
        }
        .todo-check.checked { background: var(--success); border-color: var(--success); color: white; }
        .todo-text { flex: 1; }
        .todo-text.checked { text-decoration: line-through; color: var(--text-light); }
        
        .maint-status { font-size: 0.75rem; padding: 4px 8px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .status-pending { background: var(--danger-light); color: var(--danger); }
        .status-fixed { background: var(--success-light); color: var(--success); }

    </style>
</head>
<body data-theme="light">

    <header>
        <div class="header-content">
            <h1 id="appTitle">üéì StudentStay</h1>
            <div id="appSubtitle" class="header-sub">Manager</div>
        </div>
        <button class="header-btn" onclick="openSettings()">‚öôÔ∏è</button>
    </header>

    <div id="view-dashboard">
        <!-- Search -->
        <div class="search-container">
            <input type="text" class="search-input" placeholder="üîç Search..." oninput="handleSearch(this.value)">
        </div>

        <!-- Month Picker -->
        <div class="month-picker-container">
            <label for="monthPicker" style="font-size:0.8rem; color:var(--text-light); text-transform:uppercase; font-weight:700;">Viewing:</label>
            <input type="month" id="monthPicker" class="month-picker-input" onchange="handleMonthChange(this.value)">
        </div>

        <!-- Alerts -->
        <div id="dashboardAlerts"></div>

        <!-- Stats -->
        <div class="summary-bar">
            <div class="summary-card income">
                <span class="sum-label">Collected</span>
                <span class="sum-val" id="totalCollected">$0</span>
                <span class="sum-sub">Income</span>
            </div>
            <div class="summary-card pending" onclick="openPendingView()">
                <span class="sum-label">Pending</span>
                <span class="sum-val" style="color:var(--danger)" id="totalPending">0</span>
                <span class="sum-sub">Tap to view</span>
            </div>
            <div class="summary-card profit">
                <span class="sum-label">Profit</span>
                <span class="sum-val" style="color:var(--primary)" id="totalNet">$0</span>
                <span class="sum-sub" id="totalExpenses">Exp: $0</span>
            </div>
            <div class="summary-card occupancy">
                <span class="sum-label">Occupancy</span>
                <span class="sum-val" style="color:var(--warning)" id="totalOccupancy">0%</span>
                <span class="sum-sub" id="totalBeds">0/0 Beds</span>
            </div>
        </div>

        <!-- Income Chart -->
        <div class="chart-container">
            <div class="chart-title">Income Trend (6 Mo)</div>
            <div id="incomeChart" class="chart-bars"></div>
        </div>

        <!-- Tools Grid -->
        <div class="tools-grid">
            <div class="tool-card" onclick="openGlobalMaint()">
                <span class="tool-icon">üõ†Ô∏è</span><span>Maint</span>
            </div>
            <div class="tool-card" onclick="openReport()">
                <span class="tool-icon">üìä</span><span>Report</span>
            </div>
            <div class="tool-card" onclick="openLeaseGen()">
                <span class="tool-icon">üìù</span><span>Lease</span>
            </div>
            <div class="tool-card" onclick="openExpenses()">
                <span class="tool-icon">üìâ</span><span>Expense</span>
            </div>
            <div class="tool-card" onclick="openWaitlist()">
                <span class="tool-icon">‚è≥</span><span>Waitlist</span>
            </div>
            <div class="tool-card" onclick="openAnnounce()">
                <span class="tool-icon">üì¢</span><span>Notify</span>
            </div>
            <div class="tool-card" onclick="openTodo()">
                <span class="tool-icon">‚úÖ</span><span>To-Do</span>
            </div>
             <div class="tool-card" onclick="openSplitter()">
                <span class="tool-icon">‚ûó</span><span>Split</span>
            </div>
             <div class="tool-card" onclick="openProrated()">
                <span class="tool-icon">üìÖ</span><span>Rent</span>
            </div>
            <div class="tool-card" onclick="openMeter()">
                <span class="tool-icon">‚ö°</span><span>Meter</span>
            </div>
            <div class="tool-card" onclick="openInspection()">
                <span class="tool-icon">üìã</span><span>Inspect</span>
            </div>
            <div class="tool-card" onclick="openArchive()">
                <span class="tool-icon">üìÇ</span><span>Archive</span>
            </div>
        </div>

        <!-- Activity Feed -->
        <div class="activity-feed">
            <div class="feed-title">Recent Activity</div>
            <div id="activityLog"></div>
        </div>

        <!-- Filters -->
        <div class="filter-bar">
            <div class="filter-chip active" onclick="filterRooms('all', this)">All</div>
            <div class="filter-chip" onclick="filterRooms('paid', this)">‚úÖ Paid</div>
            <div class="filter-chip" onclick="filterRooms('pending', this)">‚ö†Ô∏è Pending</div>
            <div class="filter-chip" onclick="filterRooms('vacant', this)">üõèÔ∏è Vacant</div>
        </div>

        <!-- Room List -->
        <div id="roomListContainer"></div>
        
        <button class="fab" onclick="openAddRoom()">+</button>
    </div>

    <!-- PENDING VIEW -->
    <div id="view-pending" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-pending')">‚Üê</button><h2 style="margin:0;">Unpaid</h2></div>
        <div class="view-content" id="pendingListContainer"></div>
    </div>

    <!-- GLOBAL MAINT -->
    <div id="view-global-maint" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-global-maint')">‚Üê</button><h2 style="margin:0;">Maintenance</h2></div>
        <div class="view-content"><div id="globalMaintList"></div></div>
    </div>

    <!-- REPORT -->
    <div id="view-report" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-report')">‚Üê</button><h2 style="margin:0;">Report</h2></div>
        <div class="view-content">
            <div id="reportContent" class="report-box"></div>
            <button onclick="printReport()" class="btn-primary">üñ®Ô∏è Print</button>
        </div>
    </div>

    <!-- LEASE GEN -->
    <div id="view-lease" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-lease')">‚Üê</button><h2 style="margin:0;">Lease</h2></div>
        <div class="view-content">
            <div class="form-group"><label class="form-label">Name</label><input type="text" id="lgName" class="form-input"></div>
            <div class="form-group"><label class="form-label">Room</label><input type="text" id="lgRoom" class="form-input"></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group"><label class="form-label">Rent</label><input type="number" id="lgRent" class="form-input"></div>
                <div class="form-group"><label class="form-label">Deposit</label><input type="number" id="lgDep" class="form-input"></div>
            </div>
            <div class="form-group"><label class="form-label">Start</label><input type="date" id="lgStart" class="form-input"></div>
            <button onclick="generateLease()" class="btn-primary">Generate</button>
            <textarea id="lgOutput" class="notes-area" rows="8" style="margin-top:20px; width:100%; box-sizing:border-box;"></textarea>
        </div>
    </div>

    <!-- TO-DO -->
    <div id="view-todo" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-todo')">‚Üê</button><h2 style="margin:0;">To-Do</h2></div>
        <div class="view-content">
            <div style="display:flex; gap:10px; margin-bottom:15px;"><input type="text" id="todoInput" class="form-input" placeholder="Task..."><button onclick="addTask()" style="background:var(--primary); color:white; border:none; padding:0 20px; border-radius:12px; font-weight:bold;">+</button></div>
            <div id="todoList"></div>
        </div>
    </div>

    <!-- WAITLIST -->
    <div id="view-waitlist" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-waitlist')">‚Üê</button><h2 style="margin:0;">Waitlist</h2></div>
        <div class="view-content">
            <div style="background:var(--surface); padding:15px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
                <div style="display:flex; gap:10px;"><input type="text" id="wlName" class="form-input" placeholder="Name" style="flex:1"><input type="tel" id="wlPhone" class="form-input" placeholder="Phone" style="flex:1"></div>
                <button onclick="addToWaitlist()" class="btn-primary" style="padding:12px;">+ Add</button>
            </div>
            <div id="waitlistContainer"></div>
        </div>
    </div>

    <!-- ANNOUNCE -->
    <div id="view-announce" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-announce')">‚Üê</button><h2 style="margin:0;">Notify</h2></div>
        <div class="view-content"><textarea id="announceMsg" class="form-input" rows="4" placeholder="Message..."></textarea><div style="margin-top:10px; font-size:0.85rem; color:var(--text-light);">Tap 'Send' below to open WhatsApp per student.</div><div id="announceList" style="margin-top:15px;"></div></div>
    </div>

    <!-- EXPIRY -->
    <div id="view-expiry" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-expiry')">‚Üê</button><h2 style="margin:0;">Expiry</h2></div>
        <div class="view-content"><p style="color:var(--text-light); margin-top:0;">Leases ending in 60 days.</p><div id="expiryList"></div></div>
    </div>

    <!-- ROOM DETAIL -->
    <div id="view-room" class="slide-view">
        <div class="view-header">
            <button class="btn-back" onclick="closeView('view-room')">‚Üê</button>
            <div style="flex:1">
                <h2 style="margin:0;" id="roomViewTitle">Room</h2>
            </div>
            <button onclick="markRoomPaid()" style="background:var(--success); color:white; border:none; padding:8px 12px; border-radius:10px; font-size:0.8rem; font-weight:bold; margin-right:10px;">Mark All Paid</button>
            <button class="header-btn" style="background:var(--bg); color:var(--text);" onclick="editRoomSettings()">‚úèÔ∏è</button>
        </div>
        <div class="view-content">
            <div class="form-group">
                <textarea id="roomNotes" class="notes-area" rows="2" placeholder="üìå Notes (e.g. Broken Fan)..." oninput="saveRoomNotes()" style="width:100%; box-sizing:border-box;"></textarea>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; font-size:1rem;">Tenants</h3>
                <button onclick="openAddStudent()" style="background:var(--primary-light); border:none; color:var(--primary); font-weight:700; padding:8px 15px; border-radius:20px;">+ Add</button>
            </div>
            <div id="studentListContainer" style="margin-bottom:30px;"></div>

            <!-- Inventory -->
            <div style="border-top:1px solid var(--border); padding-top:20px; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0; font-size:1rem;">ü™ë Inventory</h3>
                    <button onclick="addInventoryItem()" style="background:var(--bg); border:1px solid var(--border); color:var(--text); padding:6px 12px; border-radius:10px; font-weight:600;">+ Add</button>
                </div>
                <div id="inventoryListContainer" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
            </div>

            <!-- Maintenance -->
            <div style="border-top:1px solid var(--border); padding-top:20px;">
                <h3 style="margin:0 0 10px 0; font-size:1rem;">üõ†Ô∏è Issues</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="maintInput" class="form-input" placeholder="Issue..." style="padding:10px;">
                    <button onclick="addMaintenance()" style="background:var(--text); color:var(--bg); border:none; border-radius:12px; font-weight:bold; padding:0 15px;">Add</button>
                </div>
                <div id="maintListContainer"></div>
            </div>
        </div>
    </div>

    <!-- STUDENT FORM -->
    <div id="view-student-form" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-student-form')">‚Üê</button><h2 style="margin:0;">Student</h2></div>
        <div class="view-content">
            <input type="hidden" id="stRoomId"><input type="hidden" id="stId">
            <div class="form-group"><label class="form-label">Name</label><input type="text" id="stName" class="form-input"></div>
            <div class="form-group"><label class="form-label">WhatsApp</label><input type="tel" id="stPhone" class="form-input"></div>
            <div class="form-group"><label class="form-label">Emerg. Contact</label><input type="text" id="stEmergency" class="form-input"></div>
            <div class="form-group"><label class="form-label">Doc Link</label><input type="url" id="stDocLink" class="form-input"></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label class="form-label">Rent</label><input type="number" id="stRent" class="form-input"></div>
                <div class="form-group" style="flex:1"><label class="form-label">Deposit</label><input type="number" id="stDeposit" class="form-input"></div>
            </div>
            <div class="form-group"><label class="form-label">Lease End</label><input type="date" id="stLease" class="form-input"></div>
            
            <button onclick="printReceipt()" style="width:100%; padding:15px; background:var(--info); color:white; border:none; border-radius:12px; margin-top:10px; font-weight:700;">üñ®Ô∏è Receipt</button>
            <button class="btn-primary" onclick="saveStudent()">Save</button>
            <button onclick="transferStudent()" id="btnTransfer" style="width:100%; padding:15px; background:var(--info-light); color:var(--info); border:1px solid var(--info); border-radius:12px; margin-top:15px; font-weight:700;">Move Room</button>
            
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="openMoveOut()" style="flex:1; padding:15px; background:var(--warning-light); color:#b45309; border:none; border-radius:12px; font-weight:700;" id="btnMoveOut">Move Out</button>
                <button onclick="deleteStudent()" style="flex:1; padding:15px; background:var(--danger-light); color:var(--danger); border:none; border-radius:12px; font-weight:700;" id="btnDeleteStudent">Delete</button>
            </div>
            <div id="stHistorySection" style="margin-top:30px; display:none; border-top:1px solid var(--border); padding-top:20px;">
                <h3 style="font-size:1rem;">History</h3>
                <div id="stHistoryList" class="history-list"></div>
                <button onclick="sendHistoryStatement()" style="width:100%; margin-top:10px; padding:12px; background:var(--info-light); color:var(--info); font-weight:700; border:none; border-radius:12px;">Send Statement</button>
            </div>
        </div>
    </div>

    <!-- MOVE OUT -->
    <div id="view-moveout" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-moveout')">‚Üê</button><h2 style="margin:0;">Settlement</h2></div>
        <div class="view-content">
            <h3 id="moStudentName" style="text-align:center; margin-top:0;">Name</h3>
            <div class="form-group"><label class="form-label">Deposit Paid</label><input type="number" id="moDeposit" class="form-input" readonly></div>
            <div class="form-group"><label class="form-label">Deductions</label><input type="number" id="moDeduction" class="form-input" oninput="calcRefund()"></div>
            <div class="form-group"><label class="form-label">Reason</label><input type="text" id="moReason" class="form-input"></div>
            <div style="background:var(--success-light); padding:20px; border-radius:16px; text-align:center; margin-top:20px;">
                <label style="color:var(--success); font-weight:700; display:block;">Refund</label>
                <span id="moRefund" style="font-size:2rem; font-weight:800; color:var(--success);">$0.00</span>
            </div>
            <button class="btn-primary" onclick="processMoveOut()" style="background:var(--danger); margin-top:20px;">Confirm & Archive</button>
        </div>
    </div>

    <!-- EXPENSES -->
    <div id="view-expenses" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-expenses')">‚Üê</button><h2 style="margin:0;">Expenses</h2></div>
        <div class="view-content">
            <div id="expenseChart" style="margin-bottom:20px; display:flex; height:20px; border-radius:10px; overflow:hidden; width:100%;"></div>
            <div style="background:var(--surface); padding:20px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
                <div class="form-group">
                    <select id="expCat" class="form-input"><option value="üí°">üí° Utilities</option><option value="üõ†Ô∏è">üõ†Ô∏è Repairs</option><option value="üåê">üåê Internet</option><option value="üßπ">üßπ Cleaning</option><option value="üìù">üìù Other</option></select>
                </div>
                <div style="display:flex; gap:10px; margin-bottom:10px;"><input type="text" id="expDesc" class="form-input" placeholder="Desc" style="flex:2"><input type="number" id="expAmount" class="form-input" placeholder="$" style="flex:1"></div>
                <input type="date" id="expDate" class="form-input" style="margin-bottom:10px;">
                <button onclick="addExpense()" class="btn-primary" style="margin-top:0;">+ Add</button>
            </div>
            <button onclick="copyLastMonthExpenses()" style="width:100%; padding:12px; background:var(--info-light); color:var(--info); border:none; border-radius:12px; font-weight:700; margin-bottom:15px;">üîÑ Copy Last Month</button>
            <div id="expenseListContainer"></div>
        </div>
    </div>

    <!-- INSPECTION TOOL -->
    <div id="view-inspection" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-inspection')">‚Üê</button><h2 style="margin:0;">Inspection</h2></div>
        <div class="view-content">
            <div class="form-group"><label class="form-label">Select Room</label><select id="inspRoom" class="form-input"></select></div>
            <div id="inspList" style="border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--surface); margin-bottom:20px;"></div>
            <button class="btn-primary" onclick="saveInspection()">Save Report</button>
        </div>
    </div>
    
    <!-- METER TOOL -->
    <div id="view-meter" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-meter')">‚Üê</button><h2 style="margin:0;">Meter</h2></div>
        <div class="view-content">
            <div class="form-group"><label class="form-label">Previous</label><input type="number" id="metPrev" class="form-input"></div>
            <div class="form-group"><label class="form-label">Current</label><input type="number" id="metCurr" class="form-input"></div>
            <div class="form-group"><label class="form-label">Rate ($)</label><input type="number" id="metRate" class="form-input" value="1"></div>
            <button class="btn-primary" onclick="calcMeter()">Calculate</button>
            <div id="metResult" style="margin-top:20px; text-align:center; display:none;">
                <div style="font-size:2rem; font-weight:bold; color:var(--primary);" id="metCost">$0</div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="meterToExp()" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--surface);">To Expense</button>
                    <button onclick="meterToSplit()" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--surface);">To Split</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SPLIT -->
    <div id="view-splitter" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-splitter')">‚Üê</button><h2 style="margin:0;">Split Bill</h2></div>
        <div class="view-content">
            <div class="form-group"><label class="form-label">Total ($)</label><input type="number" id="splitAmount" class="form-input" oninput="calcSplit()"></div>
            <div class="form-group"><label class="form-label">Active Tenants</label><input type="number" id="splitCount" class="form-input" readonly></div>
            <div style="text-align:center; margin-top:30px;"><span id="splitResult" style="font-size:3rem; font-weight:800; color:var(--primary);">$0.00</span><br><span style="color:var(--text-light);">Per Student</span></div>
        </div>
    </div>

    <!-- PRORATED -->
    <div id="view-prorated" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-prorated')">‚Üê</button><h2 style="margin:0;">Rent Calc</h2></div>
        <div class="view-content">
            <div class="form-group"><label class="form-label">Monthly Rent</label><input type="number" id="proRent" class="form-input" oninput="calcProrated()"></div>
            <div class="form-group"><label class="form-label">Move-in Date</label><input type="date" id="proDate" class="form-input" onchange="calcProrated()"></div>
            <div style="background:var(--success-light); padding:20px; border-radius:12px; text-align:center; margin-top:20px;">
                <label style="color:var(--success); font-weight:700;">Rent Due</label><br>
                <span id="proResult" style="font-size:2.5rem; font-weight:800; color:var(--success);">$0.00</span>
                <div id="proDays" style="font-size:0.9rem; color:var(--text); margin-top:5px;"></div>
            </div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="view-settings" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-settings')">‚Üê</button><h2 style="margin:0;">Settings</h2></div>
        <div class="view-content">
            <div class="toggle-row"><span style="font-weight:600;">üåô Dark Mode</span><div id="darkModeToggle" class="toggle-switch" onclick="toggleDarkMode()"><div class="toggle-knob"></div></div></div>
            <div style="margin-bottom:25px; padding-bottom:15px; border-bottom:1px solid var(--border);">
                <h3 style="margin-top:0; font-size:1rem; color:var(--primary);">üè† Details</h3>
                <div class="form-group"><label class="form-label">Name</label><input type="text" id="setHouseName" class="form-input" onchange="saveHouseSettings()"></div>
                <div class="form-group"><label class="form-label">Address</label><input type="text" id="setAddress" class="form-input" onchange="saveHouseSettings()"></div>
                <div class="form-group"><label class="form-label">Contact</label><input type="text" id="setContact" class="form-input" onchange="saveHouseSettings()"></div>
            </div>
            <div class="form-group"><label class="form-label">Rent Due Day</label><input type="number" id="setDueDay" class="form-input" placeholder="10" onchange="saveDueDay(this.value)"></div>
            <div class="form-group" style="margin-top:20px;">
                <button onclick="exportData()" class="form-input" style="text-align:center; margin-bottom:10px;">üíæ Backup</button>
                <button onclick="exportToExcel()" class="form-input" style="text-align:center; color:var(--success); font-weight:bold; margin-bottom:10px;">üìÑ Excel</button>
                <button onclick="copyAllNumbers()" class="form-input" style="text-align:center; color:var(--info); font-weight:bold;">üìû Copy Numbers</button>
                <input type="file" onchange="importData(this)" class="form-input" style="margin-top:20px;">
            </div>
            <div class="form-group" style="margin-top:30px;">
                <button onclick="clearAllData()" style="width:100%; padding:15px; background:var(--danger-light); color:var(--danger); border:none; border-radius:12px; font-weight:700;">Reset App</button>
            </div>
        </div>
    </div>

    <!-- ADD ROOM -->
    <div id="view-room-form" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-room-form')">‚Üê</button><h2 style="margin:0;">Room</h2></div>
        <div class="view-content">
            <input type="hidden" id="rmId">
            <div class="form-group"><label class="form-label">Name</label><input type="text" id="rmName" class="form-input"></div>
            <div class="form-group"><label class="form-label">Capacity</label><input type="number" id="rmCap" class="form-input"></div>
            <button class="btn-primary" onclick="saveRoom()">Save</button>
            <button onclick="deleteRoom()" id="btnDeleteRoom" style="width:100%; padding:15px; background:var(--danger-light); color:var(--danger); border:none; border-radius:12px; margin-top:10px; font-weight:700; display:none;">Delete</button>
        </div>
    </div>

    <!-- ARCHIVE VIEW -->
    <div id="view-archive" class="slide-view">
        <div class="view-header"><button class="btn-back" onclick="closeView('view-archive')">‚Üê</button><h2 style="margin:0;">Archive</h2></div>
        <div class="view-content" id="archiveList"></div>
    </div>

<script>
    // --- CORE DATA ---
    let rooms = JSON.parse(localStorage.getItem('studentStay_db')) || [];
    let expenses = JSON.parse(localStorage.getItem('studentStay_expenses')) || [];
    let activityLog = JSON.parse(localStorage.getItem('studentStay_activity')) || [];
    let waitlist = JSON.parse(localStorage.getItem('studentStay_waitlist')) || [];
    let archivedStudents = JSON.parse(localStorage.getItem('studentStay_archive')) || [];
    let tasks = JSON.parse(localStorage.getItem('studentStay_tasks')) || [];
    let viewDate = new Date();
    let currentFilter = 'all';
    let searchQuery = '';
    let waitlistTransferIdx = null;

    // Seed
    if(rooms.length === 0) {
        for(let i=1; i<=5; i++) rooms.push({ id: Date.now()+i, name: `Room 10${i}`, capacity: 6, students: [], maintenance: [], inventory: [] });
        save();
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('monthPicker').value = new Date().toISOString().slice(0, 7);
        initApp();
    });

    function initApp() {
        loadSettings();
        applyTheme();
        renderDashboard();
        renderActivity();
        renderChart();
        checkBackupStatus();
    }

    // --- HELPERS ---
    function getMonthKey(d) { return d.toISOString().slice(0,7); }
    function save() { 
        localStorage.setItem('studentStay_db', JSON.stringify(rooms));
        localStorage.setItem('studentStay_expenses', JSON.stringify(expenses));
        localStorage.setItem('studentStay_activity', JSON.stringify(activityLog));
        localStorage.setItem('studentStay_waitlist', JSON.stringify(waitlist));
        localStorage.setItem('studentStay_archive', JSON.stringify(archivedStudents));
        localStorage.setItem('studentStay_tasks', JSON.stringify(tasks));
    }
    function logActivity(msg) {
        const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        activityLog.unshift({ time, msg });
        if(activityLog.length > 5) activityLog.pop();
        save();
        renderActivity();
    }
    function renderActivity() {
        document.getElementById('activityLog').innerHTML = activityLog.map(a => `<div class="feed-item"><span class="feed-time">${a.time}</span><span>${a.msg}</span></div>`).join('');
    }

    // --- SAFETY CHECK ---
    function checkBackupStatus() {
        const lastBackup = localStorage.getItem('studentStay_lastBackup');
        const alertBox = document.getElementById('dashboardAlerts');
        if(!lastBackup) return; 
        const days = (new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24);
        if(days > 7) {
            alertBox.innerHTML += `<div class="alert-box warning" onclick="openSettings()">‚ö†Ô∏è Backup needed! Last saved ${Math.floor(days)} days ago.</div>`;
        }
    }

    // --- CHART ---
    function renderChart() {
        const container = document.getElementById('incomeChart');
        container.innerHTML = '';
        const today = new Date();
        const dataPoints = [];
        let maxVal = 0;

        for (let i = 5; i >= 0; i--) {
            const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
            const key = getMonthKey(d);
            let total = 0;
            rooms.forEach(r => {
                r.students.forEach(st => {
                    if (st.paidMonths && st.paidMonths.includes(key)) total += parseFloat(st.rent || 0);
                });
            });
            if(total > maxVal) maxVal = total;
            dataPoints.push({ month: d.toLocaleString('default', {month:'short'}), value: total, isCurrent: i===0 });
        }

        dataPoints.forEach(pt => {
            const height = maxVal > 0 ? (pt.value / maxVal) * 80 : 0;
            const bar = document.createElement('div');
            bar.className = 'chart-bar-col';
            bar.innerHTML = `<div class="chart-bar ${pt.isCurrent?'active':''}" style="height:${height}px;"></div><div class="chart-label">${pt.month}</div>`;
            container.appendChild(bar);
        });
    }

    // --- THEMES ---
    function toggleDarkMode() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        const newTheme = isDark ? 'light' : 'dark';
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('studentStay_theme', newTheme);
        updateToggleUI(newTheme === 'dark');
    }
    function applyTheme() {
        const theme = localStorage.getItem('studentStay_theme') || 'light';
        document.body.setAttribute('data-theme', theme);
        updateToggleUI(theme === 'dark');
    }
    function updateToggleUI(isDark) {
        const el = document.getElementById('darkModeToggle');
        if(isDark) el.classList.add('on'); else el.classList.remove('on');
    }

    // --- SETTINGS ---
    function openSettings() { loadSettings(); openView('view-settings'); }
    function loadSettings() {
        const s = JSON.parse(localStorage.getItem('studentStay_settings')) || {};
        if(document.getElementById('setHouseName')) document.getElementById('setHouseName').value = s.name || "";
        if(document.getElementById('setAddress')) document.getElementById('setAddress').value = s.address || "";
        if(document.getElementById('setContact')) document.getElementById('setContact').value = s.contact || "";
        if(document.getElementById('setDueDay')) document.getElementById('setDueDay').value = localStorage.getItem('studentStay_dueDay') || 10;
        if(document.getElementById('appTitle')) document.getElementById('appTitle').textContent = s.name || "StudentStay";
        if(document.getElementById('appSubtitle')) document.getElementById('appSubtitle').textContent = s.address || "Manager";
    }
    function saveHouseSettings() {
        localStorage.setItem('studentStay_settings', JSON.stringify({
            name: document.getElementById('setHouseName').value,
            address: document.getElementById('setAddress').value,
            contact: document.getElementById('setContact').value
        }));
        loadSettings();
    }
    function saveDueDay(val) { localStorage.setItem('studentStay_dueDay', val); renderDashboard(); }

    function copyAllNumbers() {
        let numbers = [];
        rooms.forEach(r => {
            r.students.forEach(s => {
                if(s.phone) numbers.push(s.phone);
            });
        });
        if(numbers.length === 0) return alert("No phone numbers found.");
        navigator.clipboard.writeText(numbers.join(', ')).then(() => alert("Copied " + numbers.length + " numbers to clipboard!"));
    }

    // --- DASHBOARD RENDER ---
    function handleSearch(q) { searchQuery = q.toLowerCase(); renderDashboard(); }
    function handleMonthChange(val) { if(val) { viewDate = new Date(val + "-01"); renderDashboard(); } }
    
    function renderDashboard() {
        const container = document.getElementById('roomListContainer');
        container.innerHTML = '';
        const key = getMonthKey(viewDate);
        const dueDay = parseInt(localStorage.getItem('studentStay_dueDay') || 10);
        const now = new Date();
        const isLate = viewDate.getFullYear() === now.getFullYear() && viewDate.getMonth() === now.getMonth() && now.getDate() >= dueDay;

        let totColl=0, totPend=0, totExp=0, totBeds=0, occBeds=0;

        expenses.forEach(e => { if(e.date.startsWith(key)) totExp += parseFloat(e.amount); });

        rooms.forEach(r => {
            const stCount = r.students.length;
            totBeds += parseInt(r.capacity);
            occBeds += stCount;

            if (searchQuery) {
                const match = r.name.toLowerCase().includes(searchQuery) || r.students.some(s => s.name.toLowerCase().includes(searchQuery));
                if (!match) return;
            }

            let paidCount = 0, roomColl = 0, expiry=false;
            r.students.forEach(st => {
                if(st.paidMonths && st.paidMonths.includes(key)) { paidCount++; roomColl += parseFloat(st.rent||0); }
                else totPend++;
                if(st.leaseEnd && (new Date(st.leaseEnd)-new Date())/(86400000) <= 30) expiry=true;
            });
            totColl += roomColl;

            let status = stCount===0 ? 'vacant' : (paidCount===stCount ? 'paid' : 'pending');
            if(!searchQuery && currentFilter!=='all' && currentFilter!==status) {
                if(currentFilter==='vacant' && stCount < r.capacity){} else return;
            }

            let beds = '';
            for(let i=0; i<r.capacity; i++) beds += i<stCount ? '<span class="bed-filled">üõèÔ∏è</span>' : '<span class="bed-empty">‚≠ï</span>';
            
            const div = document.createElement('div');
            div.className = 'room-card';
            div.onclick = () => openRoom(r.id);
            div.innerHTML = `
                <div class="room-top-bar ${status==='paid'?'bar-green':(status==='vacant'?'bar-blue':'bar-red')}"></div>
                <div class="room-content">
                    <div class="room-header"><span class="room-title">${r.name}</span><span class="room-badge ${status==='paid'?'bg-green':(status==='vacant'?'bg-blue':'bg-red')}">${status.toUpperCase()}</span></div>
                    ${expiry?'<div class="expiry-icon">üïí</div>':''}
                    <div class="bed-visuals">${beds}</div>
                    <div class="room-footer"><span>${stCount}/${r.capacity} Occupied</span><span>$${roomColl}</span></div>
                </div>
            `;
            container.appendChild(div);
        });

        document.getElementById('totalCollected').textContent = '$'+totColl;
        document.getElementById('totalPending').textContent = totPend;
        document.getElementById('totalExpenses').textContent = 'Exp: $'+totExp;
        const net = totColl - totExp;
        document.getElementById('totalNet').textContent = '$'+net;
        document.getElementById('totalNet').style.color = net>=0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('totalOccupancy').textContent = (totBeds>0 ? Math.round((occBeds/totBeds)*100) : 0) + '%';
        document.getElementById('totalBeds').textContent = `${occBeds}/${totBeds} Beds`;

        const alerts = document.getElementById('dashboardAlerts');
        alerts.innerHTML = (isLate && totPend>0) ? `<div class="alert-box" onclick="openPendingView()">üö® Rent Due! ${totPend} late. Tap to view.</div>` : '';
        checkBackupStatus();
    }

    function filterRooms(type, el) {
        currentFilter = type;
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('searchInput').value = ''; searchQuery=''; renderDashboard();
    }

    // --- ROOM DETAIL & MAINTENANCE & INVENTORY ---
    let curRoomId = null;
    function openRoom(id) {
        curRoomId = id;
        const r = rooms.find(x => x.id == id);
        if(!r.maintenance) r.maintenance = [];
        if(!r.inventory) r.inventory = [];
        document.getElementById('roomViewTitle').textContent = r.name;
        document.getElementById('roomNotes').value = r.notes || '';
        renderStudents();
        renderMaintenance();
        renderInventory();
        openView('view-room');
    }

    function markRoomPaid() {
        if(!confirm("Mark all students in this room as PAID?")) return;
        const r = rooms.find(x => x.id == curRoomId);
        const key = getMonthKey(viewDate);
        r.students.forEach(st => {
            if(!st.paidMonths) st.paidMonths = [];
            if(!st.paidMonths.includes(key)) st.paidMonths.push(key);
        });
        save(); renderStudents(); renderDashboard();
    }

    function saveRoomNotes() {
        const r = rooms.find(x => x.id == curRoomId);
        r.notes = document.getElementById('roomNotes').value;
        save();
    }

    function renderStudents() {
        const div = document.getElementById('studentListContainer');
        div.innerHTML = '';
        const r = rooms.find(x => x.id == curRoomId);
        const key = getMonthKey(viewDate);
        if(r.students.length === 0) div.innerHTML = '<div style="text-align:center; color:var(--text-light); padding:20px;">No students.</div>';
        
        r.students.forEach(st => {
            const isPaid = st.paidMonths && st.paidMonths.includes(key);
            const el = document.createElement('div');
            el.className = 'student-item';
            
            const docBtn = st.docLink ? `<button class="action-icon btn-doc" onclick="window.open('${st.docLink}','_blank'); event.stopPropagation();">üìÑ</button>` : '';

            el.innerHTML = `
                <div class="avatar">${st.name.substring(0,2).toUpperCase()}</div>
                <div class="student-info" onclick="editStudent('${st.id}')">
                    <div class="st-name">${st.name}</div>
                    <div class="st-sub">Rent: $${st.rent}</div>
                </div>
                ${docBtn}
                <button class="action-icon btn-wa" onclick="sendWa('${st.phone}', '${st.name}', ${isPaid}, '${st.rent}')">üí¨</button>
                <button class="action-icon btn-pay ${isPaid?'paid':''}" onclick="togglePay('${st.id}')">${isPaid?'PAID':'PAY'}</button>
            `;
            div.appendChild(el);
        });
    }

    // Maintenance Logic
    function renderMaintenance() {
        const div = document.getElementById('maintListContainer');
        div.innerHTML = '';
        const r = rooms.find(x => x.id == curRoomId);
        if(!r.maintenance || r.maintenance.length === 0) {
            div.innerHTML = '<div style="padding:10px; text-align:center; color:var(--text-light); font-size:0.8rem;">No issues reported.</div>';
            return;
        }
        r.maintenance.forEach((m, idx) => {
            const el = document.createElement('div');
            el.className = 'maint-item';
            el.innerHTML = `<span style="font-size:0.9rem;">${m.desc}</span><span class="maint-status ${m.status==='pending'?'status-pending':'status-fixed'}" onclick="toggleMaint(${idx})">${m.status.toUpperCase()}</span>`;
            div.appendChild(el);
        });
    }
    function addMaintenance() {
        const desc = document.getElementById('maintInput').value;
        if(!desc) return;
        const r = rooms.find(x => x.id == curRoomId);
        r.maintenance.push({ desc, status: 'pending', date: new Date().toISOString() });
        document.getElementById('maintInput').value = '';
        save(); renderMaintenance();
    }
    function toggleMaint(idx) {
        const r = rooms.find(x => x.id == curRoomId);
        r.maintenance[idx].status = r.maintenance[idx].status === 'pending' ? 'fixed' : 'pending';
        save(); renderMaintenance();
    }

    // Inventory Logic
    function renderInventory() {
        const div = document.getElementById('inventoryListContainer');
        div.innerHTML = '';
        const r = rooms.find(x => x.id == curRoomId);
        if(!r.inventory || r.inventory.length === 0) {
            div.innerHTML = '<div style="grid-column:span 2; padding:10px; text-align:center; color:var(--text-light); font-size:0.8rem;">Empty inventory.</div>';
            return;
        }
        r.inventory.forEach((item, idx) => {
            const el = document.createElement('div');
            el.className = 'inv-item';
            el.innerHTML = `<span>${item.name} (${item.count})</span> <span style="color:var(--danger); cursor:pointer;" onclick="deleteInventory(${idx})">√ó</span>`;
            div.appendChild(el);
        });
    }
    function addInventoryItem() {
        const name = prompt("Item Name (e.g. Bed):");
        const count = prompt("Count:", "1");
        if(name && count) {
            const r = rooms.find(x => x.id == curRoomId);
            r.inventory.push({ name, count });
            save(); renderInventory();
        }
    }
    function deleteInventory(idx) {
        if(confirm("Remove item?")) {
            const r = rooms.find(x => x.id == curRoomId);
            r.inventory.splice(idx, 1);
            save(); renderInventory();
        }
    }

    // --- PRORATED CALCULATOR ---
    function openProrated() {
        document.getElementById('proDate').value = new Date().toISOString().slice(0,10);
        calcProrated();
        openView('view-prorated');
    }
    function calcProrated() {
        const rent = parseFloat(document.getElementById('proRent').value) || 0;
        const dateStr = document.getElementById('proDate').value;
        if(!dateStr) return;
        
        const date = new Date(dateStr);
        const daysInMonth = new Date(date.getFullYear(), date.getMonth()+1, 0).getDate();
        const daysRemaining = daysInMonth - date.getDate() + 1;
        
        if(daysRemaining <= 0) {
            document.getElementById('proResult').textContent = "$0.00";
            return;
        }

        const dailyRate = rent / daysInMonth;
        const total = dailyRate * daysRemaining;
        
        document.getElementById('proResult').textContent = '$' + total.toFixed(2);
        document.getElementById('proDays').textContent = `${daysRemaining} days remaining in month`;
    }

    // --- EXISTING LOGIC ---
    function togglePay(sid) {
        const r = rooms.find(x => x.id == curRoomId);
        const st = r.students.find(s => s.id == sid);
        const key = getMonthKey(viewDate);
        if(!st.paidMonths) st.paidMonths = [];
        if(st.paidMonths.includes(key)) {
            st.paidMonths = st.paidMonths.filter(x => x !== key);
            logActivity(`${st.name} unmarked.`);
        } else {
            st.paidMonths.push(key);
            logActivity(`${st.name} paid.`);
        }
        save(); renderStudents(); renderDashboard(); renderChart();
    }

    function sendWa(phone, name, paid, rent) {
        if(!phone) return alert("No phone number");
        const s = JSON.parse(localStorage.getItem('studentStay_settings')) || {};
        const due = localStorage.getItem('studentStay_dueDay') || 10;
        const m = viewDate.toLocaleString('default', { month: 'long' });
        
        let msg = "";
        if(paid) {
            msg = `*RECEIPT*\nüè† ${s.name||'StudentStay'}\nName: ${name}\nMonth: ${m}\nPaid: $${rent}\n‚úÖ PAID\nThank you!`;
        } else {
            msg = `Hi ${name}, reminder: Rent for ${m} is due/pending. Please pay soon!`;
        }
        window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    // --- MOVE OUT LOGIC (ARCHIVE) ---
    function openMoveOut() {
        const stId = document.getElementById('stId').value;
        const r = rooms.find(x => x.id == curRoomId);
        const st = r.students.find(s => s.id == stId);
        
        document.getElementById('moStudentName').textContent = st.name;
        document.getElementById('moDeposit').value = st.deposit || 0;
        document.getElementById('moDeduction').value = '';
        document.getElementById('moReason').value = '';
        calcRefund();
        openView('view-moveout');
    }

    function calcRefund() {
        const dep = parseFloat(document.getElementById('moDeposit').value) || 0;
        const ded = parseFloat(document.getElementById('moDeduction').value) || 0;
        const ref = dep - ded;
        document.getElementById('moRefund').textContent = "$" + ref;
        document.getElementById('moRefund').style.color = ref >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    function processMoveOut() {
        if(!confirm("Process Settlement & Archive Student?")) return;
        
        const stId = document.getElementById('stId').value;
        const r = rooms.find(x => x.id == curRoomId);
        const st = r.students.find(s => s.id == stId);
        
        const refund = document.getElementById('moRefund').textContent;
        const dedReason = document.getElementById('moReason').value || "None";
        const msg = `*FINAL SETTLEMENT*\nTenant: ${st.name}\nDeposit: $${st.deposit||0}\nDeductions: -${document.getElementById('moDeduction').value||0} (${dedReason})\n----------------\n*REFUND: ${refund}*\n----------------\nThank you for staying with us!`;
        
        if(st.phone) window.open(`https://wa.me/${st.phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');

        // NEW: Archive instead of delete
        st.moveOutDate = new Date().toISOString().split('T')[0];
        st.refundAmount = refund;
        archivedStudents.unshift(st);

        r.students = r.students.filter(s => s.id != stId);
        logActivity(`${st.name} moved out.`);
        save();
        
        closeView('view-moveout');
        closeView('view-student-form');
        renderStudents();
        renderDashboard();
    }

    // --- ARCHIVE VIEW (NEW) ---
    function openArchive() {
        const div = document.getElementById('archiveList');
        div.innerHTML = '';
        if(archivedStudents.length === 0) div.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-light);">No archived tenants.</div>';
        
        archivedStudents.forEach((st, idx) => {
            const el = document.createElement('div');
            el.className = 'archive-item';
            el.innerHTML = `
                <div class="archive-header">
                    <span>${st.name}</span>
                    <span style="font-weight:normal; font-size:0.8rem;">${st.moveOutDate}</span>
                </div>
                <div class="archive-sub">
                    Phone: ${st.phone}<br>
                    Refunded: ${st.refundAmount}
                </div>
                <button onclick="deleteArchive(${idx})" style="float:right; margin-top:-20px; background:none; border:none; color:var(--danger); cursor:pointer;">üóëÔ∏è</button>
            `;
            div.appendChild(el);
        });
        openView('view-archive');
    }
    
    function deleteArchive(idx) {
        if(confirm("Permanently delete this record?")) {
            archivedStudents.splice(idx, 1);
            save(); openArchive();
        }
    }

    // --- TO-DO LIST (NEW) ---
    function openTodo() { renderTasks(); openView('view-todo'); }
    function renderTasks() {
        const div = document.getElementById('todoList');
        div.innerHTML = '';
        if(tasks.length === 0) div.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-light);">No tasks.</div>';
        
        tasks.forEach((t, idx) => {
            const el = document.createElement('div');
            el.className = 'todo-item';
            el.innerHTML = `
                <div class="todo-check ${t.done?'checked':''}" onclick="toggleTask(${idx})">‚úì</div>
                <div class="todo-text ${t.done?'checked':''}">${t.text}</div>
                <span style="color:var(--danger); cursor:pointer; font-size:1.2rem;" onclick="deleteTask(${idx})">√ó</span>
            `;
            div.appendChild(el);
        });
    }
    function addTask() {
        const text = document.getElementById('todoInput').value;
        if(!text) return;
        tasks.push({ text, done: false });
        document.getElementById('todoInput').value = '';
        save(); renderTasks();
    }
    function toggleTask(idx) { tasks[idx].done = !tasks[idx].done; save(); renderTasks(); }
    function deleteTask(idx) { tasks.splice(idx, 1); save(); renderTasks(); }
    
    // --- INSPECTION & METER ---
    function openInspection() {
        const sel = document.getElementById('inspRoom');
        sel.innerHTML = '';
        rooms.forEach(r => {
             sel.innerHTML += `<option value="${r.id}">${r.name}</option>`;
        });
        // Generate checklist
        const items = ["Lights", "Fan", "Walls", "Windows", "Door Lock", "Bed", "Table"];
        const listDiv = document.getElementById('inspList');
        listDiv.innerHTML = items.map(i => `
            <div class="inspect-item">
                <span>${i}</span>
                <div style="display:flex; gap:10px;">
                    <div class="inspect-check pass" onclick="toggleInsp(this)">‚úì</div>
                    <div class="inspect-check" onclick="toggleInsp(this)" style="border-color:var(--danger); color:var(--danger)">√ó</div>
                </div>
            </div>
        `).join('');
        openView('view-inspection');
    }
    function toggleInsp(el) {
        // Simple visual toggle for now
        const parent = el.parentNode;
        parent.querySelectorAll('.inspect-check').forEach(c => c.style.opacity = '0.3');
        el.style.opacity = '1';
        el.classList.add('selected');
    }
    function saveInspection() {
        const rid = document.getElementById('inspRoom').value;
        const r = rooms.find(x => x.id == rid);
        const fails = [];
        document.querySelectorAll('.inspect-item').forEach(row => {
            const failBtn = row.querySelectorAll('.inspect-check')[1];
            if(failBtn.classList.contains('selected')) fails.push(row.querySelector('span').innerText);
        });
        
        const note = fails.length > 0 ? `Inspection Failed: ${fails.join(', ')}` : `Inspection Passed (${new Date().toLocaleDateString()})`;
        
        if(!r.maintenance) r.maintenance = [];
        r.maintenance.push({ desc: note, status: fails.length>0?'pending':'fixed', date: new Date().toISOString() });
        save();
        alert("Report saved to Room Maintenance Log.");
        closeView('view-inspection');
    }
    
    function openMeter() { document.getElementById('metResult').style.display='none'; openView('view-meter'); }
    function calcMeter() {
        const p = parseFloat(document.getElementById('metPrev').value)||0;
        const c = parseFloat(document.getElementById('metCurr').value)||0;
        const r = parseFloat(document.getElementById('metRate').value)||0;
        if(c < p) return alert("Current reading cannot be less than previous.");
        const cost = (c - p) * r;
        document.getElementById('metCost').innerText = '$' + cost.toFixed(2);
        document.getElementById('metResult').style.display = 'block';
    }
    function meterToExp() {
        const amt = document.getElementById('metCost').innerText.replace('$','');
        document.getElementById('expAmount').value = amt;
        document.getElementById('expDesc').value = 'Electricity Bill (Meter)';
        openExpenses();
    }
    function meterToSplit() {
        const amt = document.getElementById('metCost').innerText.replace('$','');
        document.getElementById('splitAmount').value = amt;
        openSplitter();
    }

    // --- CRUD WRAPPERS ---
    function openAddStudent() { 
        document.getElementById('stId').value=''; 
        document.getElementById('stName').value=''; 
        document.getElementById('stPhone').value='';
        document.getElementById('stRent').value='';
        document.getElementById('stDeposit').value='';
        document.getElementById('stLease').value='';
        document.getElementById('stDocLink').value='';
        document.getElementById('stEmergency').value=''; // NEW
        document.getElementById('btnDeleteStudent').style.display='none';
        document.getElementById('btnMoveOut').style.display='none';
        document.getElementById('stHistorySection').style.display='none';
        
        waitlistTransferIdx = null;
        
        openView('view-student-form');
    }
    function editStudent(sid) {
        const st = rooms.find(x=>x.id==curRoomId).students.find(s=>s.id==sid);
        document.getElementById('stId').value=sid;
        document.getElementById('stName').value=st.name;
        document.getElementById('stPhone').value=st.phone;
        document.getElementById('stRent').value=st.rent;
        document.getElementById('stDeposit').value=st.deposit||'';
        document.getElementById('stLease').value=st.leaseEnd||'';
        document.getElementById('stDocLink').value=st.docLink||'';
        document.getElementById('stEmergency').value=st.emergency||''; // NEW
        document.getElementById('btnDeleteStudent').style.display='block';
        document.getElementById('btnMoveOut').style.display='block';
        document.getElementById('stHistorySection').style.display='block';
        document.getElementById('btnTransfer').style.display='block';
        renderPaymentHistory(sid);
        openView('view-student-form');
    }
    
    function renderPaymentHistory(sid) {
        const r = rooms.find(x => x.id == curRoomId);
        const st = r.students.find(s => s.id == sid);
        const div = document.getElementById('stHistoryList');
        div.innerHTML = '';
        
        const today = new Date();
        for (let i = 0; i < 6; i++) {
            const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
            const key = getMonthKey(d);
            const monthName = d.toLocaleString('default', {month:'long', year:'numeric'});
            const isPaid = st.paidMonths && st.paidMonths.includes(key);
            
            div.innerHTML += `
                <div class="history-item">
                    <span>${monthName}</span>
                    <span class="hist-status ${isPaid ? 'hist-paid' : 'hist-pending'}">
                        ${isPaid ? 'PAID' : 'PENDING'}
                    </span>
                </div>
            `;
        }
    }

    function sendHistoryStatement() {
        const sid = document.getElementById('stId').value;
        const r = rooms.find(x => x.id == curRoomId);
        const st = r.students.find(s => s.id == sid);
        if(!st.phone) return alert("No phone number");
        
        const s = JSON.parse(localStorage.getItem('studentStay_settings')) || {};
        const houseName = s.name || "StudentStay";
        
        let msg = `*PAYMENT STATEMENT*\nüè† ${houseName}\nTenant: ${st.name}\n\n`;
        const today = new Date();
        for (let i = 0; i < 6; i++) {
            const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
            const key = getMonthKey(d);
            const monthName = d.toLocaleString('default', {month:'short', year:'numeric'});
            const isPaid = st.paidMonths && st.paidMonths.includes(key);
            msg += `${monthName}: ${isPaid ? '‚úÖ Paid' : '‚ùå Pending'}\n`;
        }
        msg += `\nThank you!`;
        window.open(`https://wa.me/${st.phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function renewLease() {
        const el = document.getElementById('stLease');
        if(!el.value) return alert("Please set a lease date first.");
        const current = new Date(el.value);
        current.setMonth(current.getMonth() + 6);
        el.value = current.toISOString().slice(0, 10);
    }

    function printReceipt() {
        const sid = document.getElementById('stId').value;
        const r = rooms.find(x => x.id == curRoomId);
        const st = r.students.find(s => s.id == sid);
        const settings = JSON.parse(localStorage.getItem('studentStay_settings')) || {};
        const houseName = settings.name || "StudentStay";
        const houseAddr = settings.address || "";
        const houseContact = settings.contact || "";
        const date = new Date().toLocaleDateString();
        const month = viewDate.toLocaleString('default', { month: 'long', year: 'numeric' });
        
        const receiptHTML = `
            <html>
            <head>
                <title>Receipt - ${st.name}</title>
                <style>
                    body { font-family: 'Segoe UI', sans-serif; padding: 40px; color: #333; }
                    .receipt-box { border: 2px solid #333; padding: 30px; max-width: 500px; margin: 0 auto; }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #ccc; padding-bottom: 20px; }
                    .h-name { font-size: 1.5rem; font-weight: bold; }
                    .h-sub { font-size: 0.9rem; color: #666; }
                    .row { display: flex; justify-content: space-between; margin-bottom: 15px; }
                    .label { font-weight: bold; }
                    .total { font-size: 1.2rem; font-weight: bold; border-top: 2px solid #333; padding-top: 10px; margin-top: 20px; }
                    .footer { text-align: center; margin-top: 40px; font-size: 0.8rem; color: #666; }
                    @media print { .no-print { display: none; } }
                </style>
            </head>
            <body>
                <div class="receipt-box">
                    <div class="header">
                        <div class="h-name">${houseName}</div>
                        <div class="h-sub">${houseAddr}</div>
                        <div class="h-sub">${houseContact}</div>
                    </div>
                    <h2 style="text-align:center;">PAYMENT RECEIPT</h2>
                    <div class="row"><span class="label">Date:</span> <span>${date}</span></div>
                    <div class="row"><span class="label">Receipt #:</span> <span>${Date.now().toString().slice(-6)}</span></div>
                    <div class="row"><span class="label">Tenant:</span> <span>${st.name}</span></div>
                    <div class="row"><span class="label">Room:</span> <span>${r.name}</span></div>
                    <br>
                    <div class="row"><span class="label">Description:</span> <span>Rent for ${month}</span></div>
                    <div class="row total"><span class="label">Total Amount:</span> <span>$${st.rent}</span></div>
                    
                    <div class="footer">
                        <p>Thank you for your payment!</p>
                        <p>Authorized Signature: _______________________</p>
                    </div>
                </div>
                <div style="text-align:center; margin-top:20px;" class="no-print">
                    <button onclick="window.print()" style="padding:10px 20px; font-size:1rem; cursor:pointer;">Print Now</button>
                </div>
            </body>
            </html>
        `;
        
        const win = window.open('', '_blank');
        win.document.write(receiptHTML);
        win.document.close();
    }

    function saveStudent() {
        const sid = document.getElementById('stId').value;
        const r = rooms.find(x=>x.id==curRoomId);
        const data = {
            id: sid || Date.now(),
            name: document.getElementById('stName').value,
            phone: document.getElementById('stPhone').value,
            rent: document.getElementById('stRent').value,
            deposit: document.getElementById('stDeposit').value,
            leaseEnd: document.getElementById('stLease').value,
            docLink: document.getElementById('stDocLink').value,
            emergency: document.getElementById('stEmergency').value, // NEW
            paidMonths: sid ? r.students.find(s=>s.id==sid).paidMonths : []
        };
        if(!data.name) return alert("Name required");
        
        if(sid) { r.students[r.students.findIndex(s=>s.id==sid)] = data; }
        else {
            if(r.students.length >= r.capacity) return alert("Room Full");
            r.students.push(data);
            logActivity(`Added ${data.name}`);
        }
        
        if(waitlistTransferIdx !== null) {
            waitlist.splice(waitlistTransferIdx, 1);
            waitlistTransferIdx = null;
            localStorage.setItem('studentStay_waitlist', JSON.stringify(waitlist));
        }

        save(); renderStudents(); renderDashboard(); renderChart(); closeView('view-student-form');
    }
    function deleteStudent() {
        if(confirm("Delete?")) {
            const r = rooms.find(x=>x.id==curRoomId);
            r.students = r.students.filter(s=>s.id!=document.getElementById('stId').value);
            save(); renderStudents(); renderDashboard(); closeView('view-student-form');
        }
    }

    // NEW: Transfer Student
    function transferStudent() {
        const sid = document.getElementById('stId').value;
        const newRoomName = prompt("Enter ID/Name of Room to move to (e.g. Room 102):");
        const targetRoom = rooms.find(r => r.name === newRoomName);
        
        if(!targetRoom) return alert("Room not found. Check exact name.");
        if(targetRoom.students.length >= targetRoom.capacity) return alert("Target room is full.");
        
        const sourceRoom = rooms.find(x => x.id == curRoomId);
        const studentIndex = sourceRoom.students.findIndex(s => s.id == sid);
        const student = sourceRoom.students[studentIndex];
        
        targetRoom.students.push(student);
        sourceRoom.students.splice(studentIndex, 1);
        
        save();
        alert(`Moved ${student.name} to ${targetRoom.name}`);
        closeView('view-student-form');
        closeView('view-room'); 
        renderDashboard();
    }

    // --- WAITLIST LOGIC ---
    function openWaitlist() {
        const div = document.getElementById('waitlistContainer');
        div.innerHTML = '';
        if(waitlist.length === 0) div.innerHTML = '<div style="text-align:center; padding:10px; color:var(--text-light);">No one waiting.</div>';
        
        waitlist.forEach((p, idx) => {
            const el = document.createElement('div');
            el.className = 'wl-item';
            el.innerHTML = `
                <div><b>${p.name}</b><br><small>${p.phone}</small></div>
                <div>
                    <button class="btn-assign" onclick="assignFromWaitlist(${idx})">Assign</button>
                    <button class="wl-btn" onclick="deleteWaitlist(${idx})">Remove</button>
                </div>
            `;
            div.appendChild(el);
        });
        openView('view-waitlist');
    }
    function addToWaitlist() {
        const name = document.getElementById('wlName').value;
        const phone = document.getElementById('wlPhone').value;
        if(!name) return;
        waitlist.push({name, phone});
        document.getElementById('wlName').value='';
        document.getElementById('wlPhone').value='';
        save(); openWaitlist();
    }
    function deleteWaitlist(idx) {
        if(confirm("Remove?")) { waitlist.splice(idx,1); save(); openWaitlist(); }
    }
    
    function assignFromWaitlist(idx) {
        const div = document.getElementById('waitlistContainer');
        const available = rooms.filter(r => r.students.length < r.capacity);
        
        if(available.length === 0) {
            alert("No rooms have vacancy right now!");
            return;
        }

        let html = `<div style="text-align:center; margin-bottom:15px;"><h3>Select Room for ${waitlist[idx].name}</h3></div>`;
        available.forEach(r => {
            html += `<div class="wl-item" onclick="confirmAssign(${idx}, ${r.id})" style="cursor:pointer; border:2px solid var(--success-light);">
                <b>${r.name}</b>
                <span style="font-size:0.8rem; background:var(--success-light); color:var(--success); padding:2px 8px; border-radius:10px;">${r.capacity - r.students.length} spots free</span>
            </div>`;
        });
        html += `<button onclick="openWaitlist()" style="width:100%; padding:15px; background:var(--text-light); color:white; border:none; border-radius:12px; font-weight:700; margin-top:10px;">Cancel</button>`;
        div.innerHTML = html;
    }

    function confirmAssign(wlIdx, roomId) {
        curRoomId = roomId;
        openAddStudent();
        const person = waitlist[wlIdx];
        document.getElementById('stName').value = person.name;
        document.getElementById('stPhone').value = person.phone;
        waitlistTransferIdx = wlIdx;
        closeView('view-waitlist'); 
    }

    // Splitter & Expense & Room CRUD same as before...
    function openSplitter() { 
        let total=0; rooms.forEach(r=>total+=r.students.length);
        document.getElementById('splitCount').value=total; 
        calcSplit(); openView('view-splitter');
    }
    function calcSplit() {
        const amt = parseFloat(document.getElementById('splitAmount').value)||0;
        const cnt = parseInt(document.getElementById('splitCount').value)||1;
        document.getElementById('splitResult').textContent = '$'+(cnt>0?amt/cnt:0).toFixed(2);
    }
    
    function openExpenses() { document.getElementById('expDate').value=new Date().toISOString().slice(0,10); renderExpenses(); openView('view-expenses'); }
    function renderExpenses() {
        const div = document.getElementById('expenseListContainer'); div.innerHTML='';
        const key = getMonthKey(viewDate);
        const expMonth = expenses.filter(e=>e.date.startsWith(key));
        
        // Chart Data
        const cats = {};
        let total = 0;
        expMonth.forEach(e => {
            if(!cats[e.cat]) cats[e.cat] = 0;
            cats[e.cat] += parseFloat(e.amount);
            total += parseFloat(e.amount);
        });
        
        const chartDiv = document.getElementById('expenseChart');
        chartDiv.innerHTML = '';
        if(total > 0) {
            for(const [cat, val] of Object.entries(cats)) {
                const pct = (val/total)*100;
                let color = '#94a3b8';
                if(cat.includes('üí°')) color = '#f59e0b';
                if(cat.includes('üõ†Ô∏è')) color = '#ef4444';
                if(cat.includes('üåê')) color = '#3b82f6';
                if(cat.includes('üßπ')) color = '#10b981';
                chartDiv.innerHTML += `<div style="width:${pct}%; background:${color}; height:100%;" title="${cat}: $${val}"></div>`;
            }
        }

        expMonth.forEach(e=>{
            div.innerHTML+=`<div class="student-item" style="justify-content:space-between">
                <div><span style="font-size:1.2rem; margin-right:5px;">${e.cat||'üìù'}</span><b>${e.desc}</b><div style="font-size:0.8rem;color:var(--text-light)">${e.date}</div></div>
                <div style="text-align:right"><b style="color:var(--danger)">-$${e.amount}</b> <span onclick="delExp(${e.id})">√ó</span></div>
            </div>`;
        });
    }
    function addExpense() {
        const cat=document.getElementById('expCat').value; const desc=document.getElementById('expDesc').value; const amt=document.getElementById('expAmount').value;
        if(!desc || !amt) return;
        expenses.push({id:Date.now(), cat, desc, amount:amt, date:document.getElementById('expDate').value});
        logActivity(`Exp: ${desc}`); save(); renderExpenses(); renderDashboard();
        document.getElementById('expDesc').value=''; document.getElementById('expAmount').value='';
    }
    function delExp(id) { if(confirm("Del?")) { expenses=expenses.filter(e=>e.id!=id); save(); renderExpenses(); renderDashboard(); } }

    // 4.1 Copy Expenses Feature
    function copyLastMonthExpenses() {
        if(!confirm("Duplicate all expenses from last month to this month?")) return;
        
        const currentMonth = new Date(viewDate);
        const lastMonth = new Date(viewDate);
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        
        const lastKey = getMonthKey(lastMonth);
        const currentKey = getMonthKey(currentMonth);
        
        const toCopy = expenses.filter(e => e.date.startsWith(lastKey));
        
        if(toCopy.length === 0) return alert("No expenses found in last month (" + lastKey + ")");
        
        let count = 0;
        toCopy.forEach(e => {
            const oldDate = new Date(e.date);
            const newDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), oldDate.getDate());
            
            expenses.push({
                id: Date.now() + count,
                cat: e.cat,
                desc: e.desc,
                amount: e.amount,
                date: newDate.toISOString().slice(0,10)
            });
            count++;
        });
        
        save();
        renderExpenses();
        renderDashboard();
        alert(`Copied ${count} expenses from ${lastKey} to ${currentKey}.`);
    }

    function openAddRoom() { document.getElementById('rmId').value=''; document.getElementById('rmName').value=''; document.getElementById('btnDeleteRoom').style.display='none'; openView('view-room-form'); }
    function editRoomSettings() { const r=rooms.find(x=>x.id==curRoomId); document.getElementById('rmId').value=r.id; document.getElementById('rmName').value=r.name; document.getElementById('rmCap').value=r.capacity; document.getElementById('btnDeleteRoom').style.display='block'; openView('view-room-form'); }
    function saveRoom() {
        const id=document.getElementById('rmId').value; const name=document.getElementById('rmName').value; const cap=document.getElementById('rmCap').value;
        if(id) { const r=rooms.find(x=>x.id==id); r.name=name; r.capacity=cap; }
        else { rooms.push({id:Date.now(), name, capacity:cap, students:[], maintenance:[], inventory:[]}); }
        save(); renderDashboard(); closeView('view-room-form');
        if(id) { document.getElementById('roomViewTitle').textContent=name; }
    }
    function deleteRoom() { if(confirm("Delete Room?")) { rooms=rooms.filter(x=>x.id!=document.getElementById('rmId').value); save(); renderDashboard(); closeView('view-room-form'); closeView('view-room'); } }

    function openPendingView() {
        const div=document.getElementById('pendingListContainer'); div.innerHTML='';
        const key=getMonthKey(viewDate); let c=0;
        rooms.forEach(r=>{ r.students.forEach(st=>{ if(!st.paidMonths || !st.paidMonths.includes(key)) {
            c++; div.innerHTML+=`<div class="student-item"><div class="avatar" style="background:var(--danger-light);color:var(--danger)">!</div><div class="student-details"><span class="student-name">${st.name}</span><span class="student-meta">${r.name} ‚Ä¢ $${st.rent}</span></div><button class="action-icon btn-wa" onclick="sendWa('${st.phone}','${st.name}',false)">üí¨</button></div>`;
        }});});
        if(c===0) div.innerHTML='<div style="text-align:center;padding:20px;">All paid! üéâ</div>';
        openView('view-pending');
    }

    // NEW: Announcements
    function openAnnounce() {
        const div = document.getElementById('announceList');
        div.innerHTML = '';
        rooms.forEach(r => {
            r.students.forEach(st => {
                div.innerHTML += `<div class="list-item-block">
                    <span>${st.name} (${r.name})</span>
                    <button class="btn-action btn-green" onclick="sendAnnounce('${st.phone}')">Send</button>
                </div>`;
            });
        });
        openView('view-announce');
    }
    function sendAnnounce(phone) {
        if(!phone) return alert("No number");
        const msg = document.getElementById('announceMsg').value;
        if(!msg) return alert("Type a message first");
        window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    // NEW: Expiry Report
    function openExpiryReport() {
        const div = document.getElementById('expiryList');
        div.innerHTML = '';
        let list = [];
        rooms.forEach(r => {
            r.students.forEach(st => {
                if(st.leaseEnd) {
                    const diff = (new Date(st.leaseEnd) - new Date()) / 86400000;
                    if(diff < 60) list.push({...st, room: r.name, days: Math.ceil(diff)});
                }
            });
        });
        list.sort((a,b) => a.days - b.days);
        
        if(list.length === 0) div.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">No leases expiring soon.</div>';
        
        list.forEach(i => {
            div.innerHTML += `<div class="list-item-block" style="border-left:4px solid ${i.days<0?'red':'orange'}">
                <div><b>${i.name}</b> (${i.room})<br><small>Ends: ${i.leaseEnd}</small></div>
                <div style="font-weight:bold; ${i.days<0?'color:red':''}">${i.days} days</div>
            </div>`;
        });
        openView('view-expiry');
    }

    function openView(id) { document.getElementById(id).classList.add('active'); }
    function closeView(id) { document.getElementById(id).classList.remove('active'); }
    function clearAllData() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }
    
    // Exports
    function exportData() { 
        const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify({rooms,expenses,activityLog,waitlist,archivedStudents,tasks})); a.download='backup.json'; a.click(); 
        localStorage.setItem('studentStay_lastBackup', new Date().toISOString());
        renderDashboard(); 
    }
    function exportToExcel() {
        let csv="Room,Student,Rent,Status\n";
        rooms.forEach(r=>{ r.students.forEach(s=>{ csv+=`${r.name},${s.name},${s.rent},${(s.paidMonths||[]).includes(getMonthKey(viewDate))?'Paid':'Pending'}\n`; })});
        const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download="report.csv"; a.click();
    }
    function importData(el) { const fr=new FileReader(); fr.onload=(e)=>{ const d=JSON.parse(e.target.result); if(d.rooms){
        rooms=d.rooms; expenses=d.expenses||[]; activityLog=d.activityLog||[]; waitlist=d.waitlist||[]; archivedStudents=d.archivedStudents||[]; tasks=d.tasks||[];
        save(); location.reload();
    } }; fr.readAsText(el.files[0]); }

    // --- GLOBAL MAINT ---
    function openGlobalMaint() {
        const div = document.getElementById('globalMaintList'); div.innerHTML='';
        let has = false;
        rooms.forEach(r => {
            const pending = (r.maintenance||[]).filter(m => m.status === 'pending');
            if(pending.length) {
                has = true;
                div.innerHTML += `<div style="margin-top:10px; font-weight:bold;">${r.name}</div>`;
                pending.forEach(m => {
                    const trueIdx = r.maintenance.findIndex(x => x === m);
                    div.innerHTML += `<div style="background:var(--bg); padding:10px; border-radius:10px; margin-top:5px; display:flex; justify-content:space-between; align-items:center;">
                        <span>${m.desc}</span> <button onclick="fixGlobalMaint('${r.id}', ${trueIdx})" style="background:var(--success); color:white; border:none; border-radius:8px; padding:4px 10px; font-size:0.8rem;">FIX</button>
                    </div>`;
                });
            }
        });
        if(!has) div.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-light);">No pending repairs.</div>';
        openView('view-global-maint');
    }
    function fixGlobalMaint(rid, idx) { rooms.find(x=>x.id==rid).maintenance[idx].status='fixed'; save(); openGlobalMaint(); }

    // --- REPORT GENERATOR ---
    function openReport() {
        const div = document.getElementById('reportContent');
        const key = getMonthKey(viewDate);
        let inc=0, exp=0;
        rooms.forEach(r => r.students.forEach(st => { if(st.paidMonths?.includes(key)) inc+=parseFloat(st.rent||0); }));
        expenses.forEach(e => { if(e.date.startsWith(key)) exp+=parseFloat(e.amount); });
        div.innerHTML = `<h3 style="text-align:center;">Monthly Report: ${key}</h3>
            <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #ccc; padding:5px 0;"><b>Income</b> <span style="color:var(--success)">$${inc}</span></div>
            <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #ccc; padding:5px 0;"><b>Expenses</b> <span style="color:var(--danger)">-$${exp}</span></div>
            <div style="display:flex; justify-content:space-between; padding:10px 0; font-size:1.1rem;"><b>NET PROFIT</b> <b>$${inc-exp}</b></div>
        `;
        openView('view-report');
    }
    function printReport() { 
        const content = document.getElementById('reportContent').innerHTML;
        const w = window.open(); w.document.write('<html><body style="font-family:sans-serif; padding:20px;">'+content+'</body></html>'); w.print(); 
    }

    // --- LEASE GENERATOR ---
    function openLeaseGen() { document.getElementById('lgName').value=''; document.getElementById('lgOutput').value=''; openView('view-lease'); }
    function generateLease() {
        const t = `LEASE AGREEMENT\nTenant: ${document.getElementById('lgName').value}\nRoom: ${document.getElementById('lgRoom').value}\nRent: $${document.getElementById('lgRent').value}\nDep: $${document.getElementById('lgDep').value}\nStart: ${document.getElementById('lgStart').value}\n\nSignatures:\nLandlord: __________\nTenant: __________`;
        document.getElementById('lgOutput').value = t;
    }

</script>
</body>
</html>